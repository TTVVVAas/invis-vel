<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Monitoramento IA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container py-4">
        <header class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <h1 class="h3 mb-0 d-flex align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                    <rect x="2" y="2" width="20" height="16" rx="2" ry="2"></rect>
                    <circle cx="8" cy="10" r="2"></circle>
                    <path d="M16 10l2-2 2 2-2 2-2-2z"></path>
                </svg>
                Centro de Monitoramento IA
            </h1>
            <div class="d-flex flex-wrap align-items-center gap-3">
                <span id="current-time" class="text-muted small"></span>
                <a href="{{ url_for('view_alerts') }}" class="btn btn-outline-primary btn-sm">Alertas</a>
                <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary btn-sm">ConfiguraÃ§Ãµes</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Sair</a>
            </div>
        </header>

        <section class="mt-4">
            <div class="row g-4">
                <div class="col-lg-8">
                    {% if cameras %}
                    <div class="row g-4">
                        {% for cam in cameras %}
                        <div class="col-12 col-md-6">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>{{ cam.name or cam.id }}</span>
                                    <span class="badge badge-offline" id="badge-{{ cam.id }}">Aguardando</span>
                                </div>
                                <div class="card-body">
                                    <img src="{{ url_for('default_video_feed') }}?camera_id={{ cam.id }}"
                                         class="cam-stream img-fluid"
                                         alt="{{ cam.name or cam.id }}">
                                    <div class="small text-muted mt-2" id="meta-{{ cam.id }}">
                                        Eventos: 0 movimento / 0 pessoa
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        Nenhuma cÃ¢mera cadastrada. Adicione entradas em <code>config.py</code> para comeÃ§ar.
                    </div>
                    {% endif %}
                </div>

                <div class="col-lg-4">
                    <div class="card mb-3">
                        <div class="card-header">Status Geral</div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <span class="status-dot" id="status-dot"></span>
                                <span class="ms-2" id="status-text">Monitorando...</span>
                            </div>
                            <ul class="list-unstyled small mb-0">
                                <li><strong>ConexÃµes:</strong> <span id="camera-connected">--</span></li>
                                <li><strong>Movimento:</strong> <span id="motion-status">Inativo</span></li>
                                <li><strong>Pessoa:</strong> <span id="person-status">NÃ£o detectado</span></li>
                                <li><strong>Ãšltima atualizaÃ§Ã£o:</strong> <span id="last-detection">--:--:--</span></li>
                                <li><strong>IA:</strong> <span id="ai-last">--</span></li>
                                <li><strong>DetecÃ§Ãµes:</strong> <span id="total-detections">0</span></li>
                                <li><strong>FPS mÃ©dio:</strong> <span id="avg-fps">--</span></li>
                            </ul>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">EstatÃ­sticas</div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div class="text-center flex-fill">
                                    <div class="stat-number" id="motion-count">0</div>
                                    <small class="text-muted">Movimentos</small>
                                </div>
                                <div class="text-center flex-fill">
                                    <div class="stat-number" id="person-count">0</div>
                                    <small class="text-muted">Pessoas</small>
                                </div>
                                <div class="text-center flex-fill">
                                    <div class="stat-number" id="alert-count">0</div>
                                    <small class="text-muted">Alertas</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">AÃ§Ãµes RÃ¡pidas</div>
                        <div class="card-body d-grid gap-2">
                            <button id="btn-config" class="btn btn-outline-light btn-sm">Configurar cÃ¢meras</button>
                            <button id="view-alerts-btn" class="btn btn-primary btn-sm">Ver alertas salvos</button>
                            <button id="btn-alerts" class="btn btn-outline-warning btn-sm">Configurar alertas</button>
                            <button id="btn-record" class="btn btn-outline-danger btn-sm">Gravar</button>
                            <button id="btn-recordings" class="btn btn-outline-info btn-sm">GravaÃ§Ãµes</button>
                            <button id="btn-settings" class="btn btn-outline-secondary btn-sm">ConfiguraÃ§Ãµes avanÃ§adas</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div id="config-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Configurar CÃ¢meras RTSP</h2>
            <form id="config-form">
                <div class="mb-3">
                    <label for="camera-select" class="form-label">CÃ¢mera</label>
                    <select id="camera-select" name="camera_id" class="form-select">
                        {% for cam in cameras %}
                        <option value="{{ cam.id }}">{{ cam.name or cam.id }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="rtsp-url" class="form-label">URL RTSP</label>
                    <input type="text" id="rtsp-url" name="rtsp_url" class="form-control"
                           placeholder="rtsp://usuario:senha@ip:554/stream">
                </div>
                <button type="submit" class="btn btn-primary w-100">Salvar ConfiguraÃ§Ãµes</button>
            </form>
        </div>
    </div>

    <script>
        let cameraConfigCache = [];

        function updateClock() {
            const now = new Date();
            const clock = document.getElementById('current-time');
            if (clock) {
                clock.textContent = now.toLocaleString('pt-BR');
            }
        }
        updateClock();
        setInterval(updateClock, 1000);

        function updateCameraBadges(cameras = []) {
            cameras.forEach(cam => {
                const badge = document.getElementById(`badge-${cam.id}`);
                const meta = document.getElementById(`meta-${cam.id}`);
                if (!badge) return;

                if (cam.connected) {
                    badge.classList.remove('badge-offline');
                    badge.classList.add('badge-online');
                    if (cam.person_detected) {
                        badge.textContent = 'Pessoa detectada';
                    } else if (cam.motion_detected) {
                        badge.textContent = 'Movimento';
                    } else {
                        badge.textContent = 'Online';
                    }
                } else {
                    badge.classList.remove('badge-online');
                    badge.classList.add('badge-offline');
                    badge.textContent = 'Offline';
                }

                if (meta) {
                    const detections = cam.detection_count ?? cam.person_events ?? 0;
                    const lastDetection = cam.last_detection || 'nunca';
                    const lastInference = cam.last_inference || 'nunca';
                    const fpsText = typeof cam.frame_rate === 'number'
                        ? `${cam.frame_rate.toFixed(1)} fps`
                        : (cam.frame_rate || '--');
                    meta.innerHTML = `
                        <div>IA: <strong>${cam.ai_active ? 'Ativa' : 'Standby'}</strong> â€¢ Ãšltima IA: ${lastInference}</div>
                        <div class="text-muted small">DetecÃ§Ãµes: ${detections} â€¢ Ãšltima detecÃ§Ã£o: ${lastDetection} â€¢ FPS: ${fpsText}</div>
                    `;
                }
            });
        }

        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    updateCameraBadges(data.cameras || []);

                    const statusDot = document.getElementById('status-dot');
                    const statusText = document.getElementById('status-text');
                    const motionStatus = document.getElementById('motion-status');
                    const personStatus = document.getElementById('person-status');
                    const lastDetection = document.getElementById('last-detection');
                    const cameraConnected = document.getElementById('camera-connected');
                    const aiLast = document.getElementById('ai-last');
                    const avgFps = document.getElementById('avg-fps');
                    const totalDetections = document.getElementById('total-detections');

                    if (data.person_detected) {
                        statusDot.className = 'status-dot danger';
                        statusText.textContent = 'Pessoa detectada';
                        personStatus.textContent = 'Ativo';
                        motionStatus.textContent = 'Movimento presente';
                    } else if (data.motion_detected) {
                        statusDot.className = 'status-dot warning';
                        statusText.textContent = 'Movimento detectado';
                        motionStatus.textContent = 'Movimento presente';
                        personStatus.textContent = 'Nenhuma pessoa';
                    } else {
                        statusDot.className = 'status-dot success';
                        statusText.textContent = 'Monitorando...';
                        motionStatus.textContent = 'Inativo';
                        personStatus.textContent = 'NÃ£o detectado';
                    }

                    if (cameraConnected) {
                        cameraConnected.textContent = data.camera_connected ? 'Online' : 'Offline';
                    }
                    if (data.timestamp && lastDetection) {
                        lastDetection.textContent = data.timestamp;
                    }
                    if (aiLast) {
                        aiLast.textContent = data.ai_last_timestamp || '--';
                    }
                    if (totalDetections) {
                        totalDetections.textContent = data.total_detections ?? 0;
                    }
                    if (avgFps) {
                        const fpsValue = typeof data.avg_fps === 'number'
                            ? `${data.avg_fps.toFixed(1)} fps`
                            : '--';
                        avgFps.textContent = fpsValue;
                    }

                    const motionCount = typeof data.motion_count === 'number' ? data.motion_count : 0;
                    const personCount = typeof data.person_count === 'number' ? data.person_count : 0;
                    const alertCount = typeof data.alert_count === 'number' ? data.alert_count : 0;
                    document.getElementById('motion-count').textContent = motionCount;
                    document.getElementById('person-count').textContent = personCount;
                    document.getElementById('alert-count').textContent = alertCount;
                })
                .catch(error => console.error('Erro ao obter status:', error));
        }
        updateStatus();
        setInterval(updateStatus, 2000);

        function setupStreamFullscreen() {
            document.querySelectorAll('.cam-stream').forEach(stream => {
                if (stream.dataset.fsBound === 'true') {
                    return;
                }
                stream.dataset.fsBound = 'true';
                stream.addEventListener('dblclick', () => {
                    const exitFullscreen = () => {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        }
                    };

                    const isFullscreen =
                        document.fullscreenElement === stream ||
                        document.webkitFullscreenElement === stream;

                    if (isFullscreen) {
                        exitFullscreen();
                        return;
                    }

                    const request = stream.requestFullscreen
                        || stream.webkitRequestFullscreen
                        || stream.msRequestFullscreen;

                    if (request) {
                        request.call(stream);
                    } else {
                        console.warn('Fullscreen API nÃ£o suportada neste navegador');
                    }
                });
            });
        }
        setupStreamFullscreen();

        const modal = document.getElementById('config-modal');
        const btnConfig = document.getElementById('btn-config');
        const closeModal = modal ? modal.querySelector('.close') : null;
        const cameraSelect = document.getElementById('camera-select');
        const rtspInput = document.getElementById('rtsp-url');

        function syncRtspField() {
            if (!cameraSelect || !rtspInput) return;
            const selected = cameraConfigCache.find(cam => cam.id === cameraSelect.value);
            rtspInput.value = selected ? (selected.rtsp_url || '') : '';
        }

        function loadCameraConfig() {
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    cameraConfigCache = data.cameras || [];
                    if (cameraSelect) {
                        cameraSelect.innerHTML = '';
                        cameraConfigCache.forEach(cam => {
                            const option = document.createElement('option');
                            option.value = cam.id;
                            option.textContent = cam.name || cam.id;
                            cameraSelect.appendChild(option);
                        });
                        syncRtspField();
                    }
                });
        }

        if (cameraSelect) {
            cameraSelect.addEventListener('change', syncRtspField);
        }

        if (btnConfig && modal) {
            btnConfig.addEventListener('click', () => {
                modal.style.display = 'block';
                loadCameraConfig();
            });
        }

        if (closeModal) {
            closeModal.addEventListener('click', () => modal.style.display = 'none');
        }

        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        const configForm = document.getElementById('config-form');
        if (configForm) {
            configForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(configForm);

                fetch('/config', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message || data.error || 'ConfiguraÃ§Ã£o salva');
                    modal.style.display = 'none';
                    updateStatus();
                })
                .catch(err => {
                    alert('Erro ao salvar configuraÃ§Ã£o');
                    console.error(err);
                });
            });
        }

        document.getElementById('view-alerts-btn')?.addEventListener('click', () => {
            window.location.href = '/alerts';
        });
        document.getElementById('btn-alerts')?.addEventListener('click', () => {
            window.open('/alerts', '_blank');
        });
        document.getElementById('btn-record')?.addEventListener('click', () => {
            alert('FunÃ§Ã£o de gravaÃ§Ã£o disponÃ­vel em breve.');
        });
        document.getElementById('btn-recordings')?.addEventListener('click', () => {
            window.location.href = '/recordings';
        });
        document.getElementById('btn-settings')?.addEventListener('click', () => {
            window.location.href = '/settings';
        });
    </script>
</body>
</html>


